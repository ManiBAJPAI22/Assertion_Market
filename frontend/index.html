<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>UMA Assertion Market</title>
<script src="https://cdnjs.cloudflare.com/ajax/libs/ethers/6.13.4/ethers.umd.min.js"></script>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link href="https://fonts.googleapis.com/css2?family=Instrument+Serif:ital@0;1&family=DM+Mono:wght@400;500&family=Manrope:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
<style>
  @keyframes revealUp {
    from { opacity: 0; transform: translateY(30px); }
    to { opacity: 1; transform: translateY(0); }
  }
  @keyframes widthGrow {
    from { width: 0; }
    to { width: 100%; }
  }
  @keyframes slideDown {
    from { opacity: 0; transform: translateY(-10px); }
    to { opacity: 1; transform: translateY(0); }
  }
  @keyframes pulse {
    0%, 100% { opacity: 1; }
    50% { opacity: 0.4; }
  }

  :root {
    --cream: #faf6f0;
    --warm: #f0ebe3;
    --paper: #e8e2d8;
    --ink: #1a1715;
    --ink-soft: #3d3833;
    --ink-muted: #8a8279;
    --vermillion: #d4380d;
    --vermillion-soft: rgba(212, 56, 13, 0.08);
    --teal: #0d6e6e;
    --teal-soft: rgba(13, 110, 110, 0.08);
    --olive: #5c6e3a;
    --olive-soft: rgba(92, 110, 58, 0.08);
    --rust: #b8520a;
    --rust-soft: rgba(184, 82, 10, 0.08);
    --serif: 'Instrument Serif', Georgia, serif;
    --sans: 'Manrope', sans-serif;
    --mono: 'DM Mono', monospace;
  }

  [data-theme="dark"] {
    --cream: #111110;
    --warm: #1a1918;
    --paper: #2a2826;
    --ink: #e8e2d8;
    --ink-soft: #c4bdb3;
    --ink-muted: #7a7368;
    --vermillion: #ff5a2d;
    --vermillion-soft: rgba(255, 90, 45, 0.12);
    --teal: #2dd4bf;
    --teal-soft: rgba(45, 212, 191, 0.1);
    --olive: #a3e635;
    --olive-soft: rgba(163, 230, 53, 0.1);
    --rust: #f59e0b;
    --rust-soft: rgba(245, 158, 11, 0.1);
  }

  * { margin: 0; padding: 0; box-sizing: border-box; }

  body {
    font-family: var(--sans);
    background: var(--cream);
    color: var(--ink);
    min-height: 100vh;
    -webkit-font-smoothing: antialiased;
  }

  /* Subtle paper texture */
  body::after {
    content: '';
    position: fixed;
    inset: 0;
    opacity: 0.3;
    background-image: url("data:image/svg+xml,%3Csvg width='200' height='200' xmlns='http://www.w3.org/2000/svg'%3E%3Cfilter id='n'%3E%3CfeTurbulence baseFrequency='0.65' numOctaves='3' stitchTiles='stitch'/%3E%3C/filter%3E%3Crect width='100%25' height='100%25' filter='url(%23n)' opacity='0.04'/%3E%3C/svg%3E");
    pointer-events: none;
    z-index: 0;
  }

  /* ── Scrollbar ──────────────────────────────── */
  ::-webkit-scrollbar { width: 8px; }
  ::-webkit-scrollbar-track { background: var(--cream); }
  ::-webkit-scrollbar-thumb { background: var(--paper); border-radius: 4px; }
  ::-webkit-scrollbar-thumb:hover { background: var(--ink-muted); }

  /* ── Header ─────────────────────────────────── */
  .header {
    position: sticky;
    top: 0;
    z-index: 100;
    padding: 20px 40px;
    background: rgba(250, 246, 240, 0.9);
    backdrop-filter: blur(16px);
    -webkit-backdrop-filter: blur(16px);
    border-bottom: 1.5px solid var(--ink);
    display: flex;
    justify-content: space-between;
    align-items: center;
    animation: slideDown 0.4s ease;
  }

  .brand {
    display: flex;
    align-items: baseline;
    gap: 16px;
  }

  .brand h1 {
    font-family: var(--serif);
    font-size: 28px;
    font-weight: 400;
    letter-spacing: -0.5px;
    color: var(--ink);
  }

  .brand h1 em {
    color: var(--vermillion);
    font-style: italic;
  }

  .mode-switch {
    display: flex;
    align-items: center;
    border: 1.5px solid var(--ink);
    border-radius: 0;
    overflow: hidden;
    font-size: 11px;
    font-family: var(--mono);
    text-transform: uppercase;
    letter-spacing: 1px;
  }

  .mode-btn {
    padding: 6px 16px;
    background: none;
    border: none;
    cursor: pointer;
    font-family: var(--mono);
    font-size: 11px;
    letter-spacing: 1px;
    text-transform: uppercase;
    color: var(--ink-muted);
    transition: all 0.2s;
  }

  .mode-btn.active {
    background: var(--ink);
    color: var(--cream);
  }

  .wallet-bar {
    display: flex;
    align-items: center;
    gap: 16px;
    font-size: 12px;
  }

  .wallet-bar .net {
    font-family: var(--mono);
    font-size: 10px;
    letter-spacing: 1.5px;
    text-transform: uppercase;
    color: var(--teal);
    border: 1px solid var(--teal);
    padding: 3px 10px;
  }

  .wallet-bar .addr {
    font-family: var(--mono);
    font-size: 12px;
    color: var(--ink-soft);
  }

  .wallet-bar .bal {
    font-family: var(--mono);
    font-size: 12px;
    font-weight: 500;
    color: var(--olive);
  }

  /* ── Buttons ────────────────────────────────── */
  .btn {
    font-family: var(--mono);
    font-size: 12px;
    letter-spacing: 0.5px;
    padding: 10px 24px;
    border: 1.5px solid var(--ink);
    background: var(--ink);
    color: var(--cream);
    cursor: pointer;
    transition: all 0.15s ease;
    text-transform: uppercase;
  }

  .btn:hover {
    background: var(--cream);
    color: var(--ink);
  }

  .btn:disabled { opacity: 0.25; cursor: not-allowed; }
  .btn:disabled:hover { background: var(--ink); color: var(--cream); }

  .btn-outline {
    background: transparent;
    color: var(--ink);
  }
  .btn-outline:hover {
    background: var(--ink);
    color: var(--cream);
  }

  .btn-vermillion {
    background: var(--vermillion);
    border-color: var(--vermillion);
    color: #fff;
  }
  .btn-vermillion:hover { background: #b82e08; border-color: #b82e08; color: #fff; }

  .btn-teal {
    background: var(--teal);
    border-color: var(--teal);
    color: #fff;
  }
  .btn-teal:hover { background: #0a5858; border-color: #0a5858; color: #fff; }

  .btn-olive {
    background: var(--olive);
    border-color: var(--olive);
    color: #fff;
  }
  .btn-olive:hover { background: #4a5a2e; border-color: #4a5a2e; color: #fff; }

  .btn-rust {
    background: var(--rust);
    border-color: var(--rust);
    color: #fff;
  }
  .btn-rust:hover { background: #9a4508; border-color: #9a4508; color: #fff; }

  .btn-sm { padding: 6px 16px; font-size: 11px; }

  /* ── Layout ─────────────────────────────────── */
  .main {
    position: relative;
    z-index: 1;
    max-width: 1080px;
    margin: 0 auto;
    padding: 48px 40px 80px;
  }

  .grid {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 0;
    border: 1.5px solid var(--ink);
    margin-bottom: 48px;
    animation: revealUp 0.6s cubic-bezier(0.16, 1, 0.3, 1) 0.2s backwards;
  }

  .grid > :first-child {
    border-right: 1.5px solid var(--ink);
  }

  @media (max-width: 760px) {
    .grid { grid-template-columns: 1fr; }
    .grid > :first-child { border-right: none; border-bottom: 1.5px solid var(--ink); }
    .main { padding: 24px 16px 60px; }
    .header { padding: 14px 16px; flex-wrap: wrap; gap: 10px; }
  }

  /* ── Contract Info Bar ──────────────────────── */
  .info-bar {
    border: 1.5px solid var(--ink);
    display: grid;
    grid-template-columns: repeat(3, 1fr);
    margin-bottom: 48px;
    animation: revealUp 0.6s cubic-bezier(0.16, 1, 0.3, 1) 0.1s backwards;
  }

  .info-bar.has-mock {
    grid-template-columns: repeat(4, 1fr);
  }

  .info-cell {
    padding: 20px 24px;
    border-right: 1.5px solid var(--ink);
  }
  .info-cell:last-child { border-right: none; }

  .info-cell .cell-label {
    font-family: var(--mono);
    font-size: 9px;
    letter-spacing: 2px;
    text-transform: uppercase;
    color: var(--ink-muted);
    margin-bottom: 6px;
  }

  .info-cell .cell-value {
    font-family: var(--mono);
    font-size: 13px;
    font-weight: 500;
    color: var(--ink);
    word-break: break-all;
  }

  /* ── Panels ─────────────────────────────────── */
  .panel {
    padding: 32px;
  }

  .panel-title {
    font-family: var(--serif);
    font-size: 26px;
    font-weight: 400;
    margin-bottom: 28px;
    color: var(--ink);
    letter-spacing: -0.3px;
  }

  /* ── Forms ──────────────────────────────────── */
  .field-label {
    display: block;
    font-family: var(--mono);
    font-size: 10px;
    letter-spacing: 1.5px;
    text-transform: uppercase;
    color: var(--ink-muted);
    margin-bottom: 8px;
    margin-top: 20px;
  }

  .field-label:first-of-type { margin-top: 0; }

  input, textarea {
    width: 100%;
    padding: 12px 0;
    background: transparent;
    border: none;
    border-bottom: 1.5px solid var(--paper);
    color: var(--ink);
    font-family: var(--sans);
    font-size: 15px;
    font-weight: 400;
    transition: border-color 0.2s;
    outline: none;
  }

  input[type="number"] {
    font-family: var(--mono);
    font-size: 20px;
    font-weight: 500;
  }

  textarea {
    resize: vertical;
    min-height: 56px;
    line-height: 1.5;
  }

  input:focus, textarea:focus {
    border-color: var(--vermillion);
  }

  input::placeholder, textarea::placeholder {
    color: var(--ink-muted);
    opacity: 0.5;
  }

  .hint {
    font-size: 11px;
    color: var(--ink-muted);
    margin-top: 6px;
    font-weight: 300;
  }

  .total-box {
    margin-top: 16px;
    padding: 12px 16px;
    background: var(--warm);
    font-family: var(--mono);
    font-size: 13px;
    color: var(--ink-soft);
    border-left: 3px solid var(--vermillion);
    display: none;
  }

  .result-box {
    margin-top: 16px;
    padding: 12px 16px;
    background: var(--teal-soft);
    border-left: 3px solid var(--teal);
    font-family: var(--mono);
    font-size: 11px;
    color: var(--teal);
    word-break: break-all;
    display: none;
  }

  .actions { display: flex; gap: 10px; margin-top: 24px; flex-wrap: wrap; }

  /* ── Data Rows ──────────────────────────────── */
  .data-row {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 10px 0;
    border-bottom: 1px solid var(--warm);
    font-size: 13px;
  }
  .data-row:last-child { border-bottom: none; }
  .data-row .dlabel { color: var(--ink-muted); font-weight: 400; font-size: 12px; }
  .data-row .dvalue {
    font-family: var(--mono);
    font-size: 12px;
    font-weight: 500;
    text-align: right;
    max-width: 55%;
    overflow: hidden;
    text-overflow: ellipsis;
  }

  /* ── Status Tags ────────────────────────────── */
  .tag {
    display: inline-flex;
    align-items: center;
    gap: 6px;
    padding: 3px 10px;
    font-family: var(--mono);
    font-size: 10px;
    font-weight: 500;
    letter-spacing: 1px;
    text-transform: uppercase;
  }

  .tag::before {
    content: '';
    width: 6px;
    height: 6px;
    border-radius: 50%;
  }

  .tag-active { background: var(--teal-soft); color: var(--teal); }
  .tag-active::before { background: var(--teal); }
  .tag-disputed { background: var(--rust-soft); color: var(--rust); }
  .tag-disputed::before { background: var(--rust); animation: pulse 1.5s ease infinite; }
  .tag-true { background: var(--olive-soft); color: var(--olive); }
  .tag-true::before { background: var(--olive); }
  .tag-false { background: var(--vermillion-soft); color: var(--vermillion); }
  .tag-false::before { background: var(--vermillion); }

  /* ── Sandbox Resolve ────────────────────────── */
  .resolve-box {
    margin-top: 20px;
    padding: 16px;
    border: 1.5px dashed var(--rust);
    background: var(--rust-soft);
  }

  .resolve-box h4 {
    font-family: var(--mono);
    font-size: 10px;
    letter-spacing: 2px;
    text-transform: uppercase;
    color: var(--rust);
    margin-bottom: 12px;
  }

  /* ── Feed ────────────────────────────────────── */
  .feed-section {
    border: 1.5px solid var(--ink);
    animation: revealUp 0.6s cubic-bezier(0.16, 1, 0.3, 1) 0.35s backwards;
  }

  .feed-header {
    padding: 20px 28px;
    border-bottom: 1.5px solid var(--ink);
    display: flex;
    justify-content: space-between;
    align-items: center;
  }

  .feed-header h2 {
    font-family: var(--serif);
    font-size: 22px;
    font-weight: 400;
  }

  .feed-body { padding: 0; }

  .feed-row {
    display: flex;
    align-items: center;
    gap: 16px;
    padding: 14px 28px;
    border-bottom: 1px solid var(--warm);
    cursor: pointer;
    transition: background 0.1s;
    font-size: 13px;
  }
  .feed-row:hover { background: var(--warm); }
  .feed-row:last-child { border-bottom: none; }

  .feed-row .fid {
    font-family: var(--mono);
    font-size: 11px;
    color: var(--ink-muted);
    min-width: 130px;
  }

  .feed-row .fclaim {
    flex: 1;
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
    font-weight: 400;
  }

  .feed-empty {
    padding: 40px 28px;
    text-align: center;
    color: var(--ink-muted);
    font-size: 13px;
    font-style: italic;
    font-family: var(--serif);
  }

  /* ── Toasts ─────────────────────────────────── */
  .toast-container {
    position: fixed;
    bottom: 24px;
    right: 24px;
    z-index: 1000;
    display: flex;
    flex-direction: column;
    gap: 8px;
  }

  .toast {
    padding: 14px 20px;
    font-family: var(--mono);
    font-size: 12px;
    max-width: 380px;
    word-break: break-all;
    animation: slideDown 0.2s ease;
    border-left: 3px solid;
  }

  .toast-pending { background: var(--warm); border-color: var(--ink-muted); color: var(--ink-soft); }
  .toast-success { background: var(--olive-soft); border-color: var(--olive); color: var(--olive); }
  .toast-error { background: var(--vermillion-soft); border-color: var(--vermillion); color: var(--vermillion); }

  /* ── Countdown Timer ──────────────────────── */
  .timer-widget {
    margin-top: 16px;
    padding: 16px 20px;
    border: 1.5px solid var(--ink);
    position: relative;
    overflow: hidden;
  }

  .timer-widget::before {
    content: '';
    position: absolute;
    inset: 0;
    background: var(--warm);
    z-index: 0;
  }

  .timer-track {
    position: absolute;
    left: 0;
    top: 0;
    bottom: 0;
    z-index: 1;
    transition: width 1s linear;
  }

  .timer-track.active { background: var(--teal-soft); border-right: 2px solid var(--teal); }
  .timer-track.urgent { background: var(--vermillion-soft); border-right: 2px solid var(--vermillion); }
  .timer-track.expired { background: var(--olive-soft); width: 100% !important; border-right: none; }
  .timer-track.disputed { background: var(--rust-soft); width: 100% !important; border-right: none; }

  .timer-content {
    position: relative;
    z-index: 2;
    display: flex;
    justify-content: space-between;
    align-items: center;
  }

  .timer-label {
    font-family: var(--mono);
    font-size: 9px;
    letter-spacing: 2px;
    text-transform: uppercase;
    color: var(--ink-muted);
  }

  .timer-value {
    font-family: var(--mono);
    font-size: 18px;
    font-weight: 500;
    letter-spacing: 2px;
    color: var(--ink);
  }

  .timer-value.urgent-text { color: var(--vermillion); }
  .timer-value.expired-text { color: var(--olive); font-size: 13px; }
  .timer-value.disputed-text { color: var(--rust); font-size: 13px; animation: pulse 2s ease infinite; }

  .timer-segments {
    display: flex;
    gap: 4px;
    align-items: baseline;
  }

  .timer-seg {
    display: flex;
    flex-direction: column;
    align-items: center;
    min-width: 38px;
  }

  .timer-seg .seg-num {
    font-family: var(--mono);
    font-size: 22px;
    font-weight: 500;
    letter-spacing: 1px;
    line-height: 1;
    color: var(--ink);
  }

  .timer-seg .seg-unit {
    font-family: var(--mono);
    font-size: 8px;
    letter-spacing: 1.5px;
    text-transform: uppercase;
    color: var(--ink-muted);
    margin-top: 2px;
  }

  .timer-colon {
    font-family: var(--mono);
    font-size: 18px;
    color: var(--ink-muted);
    padding-bottom: 10px;
    animation: pulse 1s ease infinite;
  }

  /* Feed timer compact */
  .feed-timer {
    font-family: var(--mono);
    font-size: 10px;
    color: var(--ink-muted);
    white-space: nowrap;
    min-width: 60px;
    text-align: right;
  }
  .feed-timer.urgent { color: var(--vermillion); }

  .hidden { display: none !important; }

  /* ── Dark theme overrides ───────────────────── */
  [data-theme="dark"] body::after { opacity: 0.08; }

  [data-theme="dark"] .header {
    background: rgba(17, 17, 16, 0.9);
  }

  [data-theme="dark"] .mode-btn.active {
    background: var(--ink);
    color: var(--cream);
  }

  [data-theme="dark"] .btn {
    border-color: var(--ink);
    background: var(--ink);
    color: var(--cream);
  }
  [data-theme="dark"] .btn:hover {
    background: var(--cream);
    color: var(--ink);
  }

  [data-theme="dark"] .btn-vermillion { background: var(--vermillion); border-color: var(--vermillion); color: #111; }
  [data-theme="dark"] .btn-vermillion:hover { background: #e64a1f; border-color: #e64a1f; color: #111; }
  [data-theme="dark"] .btn-teal { background: var(--teal); border-color: var(--teal); color: #111; }
  [data-theme="dark"] .btn-teal:hover { background: #22b8a4; border-color: #22b8a4; color: #111; }
  [data-theme="dark"] .btn-olive { background: var(--olive); border-color: var(--olive); color: #111; }
  [data-theme="dark"] .btn-olive:hover { background: #8fcc2a; border-color: #8fcc2a; color: #111; }
  [data-theme="dark"] .btn-rust { background: var(--rust); border-color: var(--rust); color: #111; }
  [data-theme="dark"] .btn-rust:hover { background: #d98e09; border-color: #d98e09; color: #111; }

  [data-theme="dark"] .btn-outline {
    background: transparent;
    color: var(--ink);
    border-color: var(--paper);
  }
  [data-theme="dark"] .btn-outline:hover {
    background: var(--ink);
    color: var(--cream);
  }

  [data-theme="dark"] input, [data-theme="dark"] textarea {
    color: var(--ink);
    border-color: var(--paper);
  }

  [data-theme="dark"] ::-webkit-scrollbar-track { background: var(--cream); }
  [data-theme="dark"] ::-webkit-scrollbar-thumb { background: var(--paper); }

  /* ── Theme toggle button ────────────────────── */
  .theme-toggle {
    width: 36px;
    height: 36px;
    border: 1.5px solid var(--paper);
    background: transparent;
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 16px;
    transition: all 0.2s;
    color: var(--ink-muted);
    flex-shrink: 0;
  }
  .theme-toggle:hover {
    border-color: var(--ink);
    color: var(--ink);
  }

  /* ── Decorative line ────────────────────────── */
  .deco-line {
    height: 1.5px;
    background: var(--ink);
    margin-bottom: 48px;
    animation: widthGrow 0.8s cubic-bezier(0.16, 1, 0.3, 1) 0.05s backwards;
  }

  /* ── Hero tagline ───────────────────────────── */
  .tagline {
    font-family: var(--serif);
    font-size: 42px;
    font-weight: 400;
    line-height: 1.15;
    letter-spacing: -1px;
    margin-bottom: 12px;
    color: var(--ink);
    animation: revealUp 0.6s cubic-bezier(0.16, 1, 0.3, 1) 0.05s backwards;
  }

  .tagline em {
    font-style: italic;
    color: var(--vermillion);
  }

  .sub-tagline {
    font-family: var(--mono);
    font-size: 11px;
    letter-spacing: 2px;
    text-transform: uppercase;
    color: var(--ink-muted);
    margin-bottom: 48px;
    animation: revealUp 0.6s cubic-bezier(0.16, 1, 0.3, 1) 0.12s backwards;
  }
</style>
</head>
<body>

<!-- Header -->
<div class="header">
  <div class="brand">
    <h1><em>UMA</em> Assertion Market</h1>
    <div class="mode-switch">
      <button class="mode-btn active" id="liveBtn" onclick="setMode('live')">Live</button>
      <button class="mode-btn" id="sandboxBtn" onclick="setMode('sandbox')">Sandbox</button>
    </div>
  </div>
  <div class="wallet-bar">
    <span class="net" id="networkName" style="display:none;"></span>
    <span class="addr" id="walletAddr"></span>
    <span class="bal" id="walletBal"></span>
    <button class="btn btn-sm" id="connectBtn">Connect</button>
    <button class="theme-toggle" id="themeBtn" title="Toggle theme">&#9790;</button>
  </div>
</div>

<div class="main">

  <!-- Tagline -->
  <h2 class="tagline">Assert truths,<br>stake <em>conviction.</em></h2>
  <p class="sub-tagline">Optimistic Oracle V3 &mdash; Sepolia Testnet</p>

  <div class="deco-line"></div>

  <!-- Contract Info Bar -->
  <div class="info-bar" id="infoBar">
    <div class="info-cell">
      <div class="cell-label">Contract</div>
      <div class="cell-value" id="infoAddr">---</div>
    </div>
    <div class="info-cell">
      <div class="cell-label">Bond</div>
      <div class="cell-value" id="infoBond">---</div>
    </div>
    <div class="info-cell">
      <div class="cell-label">Liveness</div>
      <div class="cell-value" id="infoLiveness">---</div>
    </div>
    <div class="info-cell hidden" id="infoMockRow">
      <div class="cell-label">Mock Oracle</div>
      <div class="cell-value" id="infoMockAddr">---</div>
    </div>
  </div>

  <!-- Two panels -->
  <div class="grid">

    <!-- Create -->
    <div class="panel">
      <div class="panel-title">New Assertion</div>
      <label class="field-label">Claim</label>
      <textarea id="claimText" placeholder="ETH was above $2500 on 1 Feb 2026"></textarea>
      <label class="field-label">Market stake (ETH)</label>
      <input type="number" id="marketAmt" step="0.001" min="0" value="0.01" placeholder="0.01">
      <div class="hint">You will send bond + market stake in one transaction.</div>
      <div class="total-box" id="totalDisplay"></div>
      <div class="actions">
        <button class="btn btn-vermillion" id="createBtn" disabled>Submit Assertion</button>
      </div>
      <div class="result-box" id="createResult"></div>
    </div>

    <!-- Lookup -->
    <div class="panel">
      <div class="panel-title">Inspect</div>
      <label class="field-label">Assertion ID</label>
      <input type="text" id="lookupId" placeholder="0x...">
      <div class="actions">
        <button class="btn btn-sm btn-outline" id="lookupBtn" disabled>Lookup</button>
      </div>

      <div id="lookupResult" class="hidden" style="margin-top:24px;">
        <div class="data-row"><span class="dlabel">Status</span><span class="dvalue" id="lrStatus">---</span></div>
        <div class="data-row"><span class="dlabel">Asserter</span><span class="dvalue" id="lrAsserter">---</span></div>
        <div class="data-row"><span class="dlabel">Disputer</span><span class="dvalue" id="lrDisputer">---</span></div>
        <div class="data-row"><span class="dlabel">Bond</span><span class="dvalue" id="lrBond">---</span></div>
        <div class="data-row"><span class="dlabel">Market Stake</span><span class="dvalue" id="lrMarket">---</span></div>
        <div class="data-row"><span class="dlabel">Created</span><span class="dvalue" id="lrTime">---</span></div>
        <div class="data-row"><span class="dlabel">Withdrawn</span><span class="dvalue" id="lrWithdrawn">---</span></div>

        <div class="timer-widget" id="timerWidget">
          <div class="timer-track" id="timerTrack"></div>
          <div class="timer-content">
            <span class="timer-label" id="timerLabel">LIVENESS</span>
            <div class="timer-segments" id="timerSegments"></div>
          </div>
        </div>

        <div class="actions" id="lrActions"></div>

        <div id="sandboxResolve" class="resolve-box hidden">
          <h4>Sandbox &mdash; Manual Resolution</h4>
          <div class="actions" style="margin-top:0;">
            <button class="btn btn-olive btn-sm" id="resolveTrue">Resolve True</button>
            <button class="btn btn-vermillion btn-sm" id="resolveFalse">Resolve False</button>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Feed -->
  <div class="feed-section">
    <div class="feed-header">
      <h2>Recent Assertions</h2>
    </div>
    <div class="feed-body" id="feed">
      <div class="feed-empty">Connect wallet to view assertions</div>
    </div>
  </div>

</div>

<div class="toast-container" id="toasts"></div>

<script>
const CONTRACTS = {
  live: {
    market: '0xDe13A4ba6b4eB0100f599228fA64d1c605d9345F',
    mockOO: null,
    label: 'Live OO v3'
  },
  sandbox: {
    market: '0x44c399D986E8E451cbeF6b52aF152fa846bAA66c',
    mockOO: '0x64d6b8CDe5a488b148A9E6FD53fD3d4a54Cce923',
    label: 'Sandbox'
  }
};

const SEPOLIA_CHAIN_ID = '0xaa36a7';

const MARKET_ABI = [
  'function createAssertion(bytes calldata claim) external payable returns (bytes32)',
  'function disputeAssertion(bytes32 assertionId) external payable',
  'function settleAssertion(bytes32 assertionId) external',
  'function withdraw(bytes32 assertionId) external',
  'function getEffectiveBond() external view returns (uint256)',
  'function getAssertionData(bytes32 assertionId) external view returns (tuple(address asserter, uint64 timestamp, uint8 status, uint128 bondAmount, uint128 marketAmount, address disputer, bool withdrawn))',
  'function defaultLiveness() external view returns (uint64)',
  'function defaultBond() external view returns (uint256)',
  'event AssertionCreated(bytes32 indexed assertionId, address indexed asserter, uint128 bondAmount, uint128 marketAmount, bytes claim)',
  'event AssertionDisputed(bytes32 indexed assertionId, address indexed disputer, uint128 disputeBond)',
  'event AssertionResolved(bytes32 indexed assertionId, bool assertedTruthfully)',
  'event FundsWithdrawn(bytes32 indexed assertionId, address indexed recipient, uint256 amount)'
];

const MOCK_OO_ABI = [
  'function resolveAssertion(bytes32 assertionId, bool truthful) external'
];

const STATUS_MAP = ['Active', 'Disputed', 'Resolved True', 'Resolved False'];
const TAG_CLASS = ['tag-active', 'tag-disputed', 'tag-true', 'tag-false'];

let provider = null;
let signer = null;
let marketContract = null;
let mockOOContract = null;
let currentMode = 'live';
let currentBond = 0n;
let currentLiveness = 0;
let currentLookupId = null;
let timerInterval = null;

const $ = id => document.getElementById(id);

// ─── Mode Switch ──────────────────────────────────────────────────
function setMode(mode) {
  currentMode = mode;
  $('liveBtn').className = 'mode-btn' + (mode === 'live' ? ' active' : '');
  $('sandboxBtn').className = 'mode-btn' + (mode === 'sandbox' ? ' active' : '');

  if (signer) {
    initContracts();
    loadContractInfo();
    loadFeed();
    if (timerInterval) { clearInterval(timerInterval); timerInterval = null; }
    $('lookupResult').classList.add('hidden');
    $('lookupId').value = '';
  }
}

// ─── Toast ────────────────────────────────────────────────────────
function toast(msg, type = 'pending', duration = 5000) {
  const el = document.createElement('div');
  el.className = `toast toast-${type}`;
  el.textContent = msg;
  $('toasts').appendChild(el);
  if (duration > 0) setTimeout(() => el.remove(), duration);
  return el;
}

// ─── Wallet ───────────────────────────────────────────────────────
async function connectWallet() {
  if (!window.ethereum) { toast('MetaMask not found', 'error'); return; }

  try {
    provider = new ethers.BrowserProvider(window.ethereum);
    await provider.send('eth_requestAccounts', []);
    signer = await provider.getSigner();

    const network = await provider.getNetwork();
    if (network.chainId !== 11155111n) {
      toast('Switching to Sepolia...', 'pending', 3000);
      try {
        await window.ethereum.request({ method: 'wallet_switchEthereumChain', params: [{ chainId: SEPOLIA_CHAIN_ID }] });
        provider = new ethers.BrowserProvider(window.ethereum);
        signer = await provider.getSigner();
      } catch (e) {
        toast('Please switch to Sepolia network', 'error');
        return;
      }
    }

    const addr = await signer.getAddress();
    const bal = await provider.getBalance(addr);
    $('walletAddr').textContent = addr.slice(0, 6) + '...' + addr.slice(-4);
    $('walletBal').textContent = parseFloat(ethers.formatEther(bal)).toFixed(4) + ' ETH';
    $('networkName').textContent = 'SEPOLIA';
    $('networkName').style.display = '';
    $('connectBtn').textContent = 'Connected';
    $('connectBtn').disabled = true;
    $('connectBtn').style.opacity = '0.4';

    initContracts();
    loadContractInfo();
    loadFeed();
    enableUI();
  } catch (e) {
    toast('Connection failed: ' + e.message, 'error');
  }
}

function initContracts() {
  const cfg = CONTRACTS[currentMode];
  marketContract = new ethers.Contract(cfg.market, MARKET_ABI, signer);
  mockOOContract = cfg.mockOO ? new ethers.Contract(cfg.mockOO, MOCK_OO_ABI, signer) : null;
}

async function loadContractInfo() {
  const cfg = CONTRACTS[currentMode];
  $('infoAddr').textContent = cfg.market;

  try {
    const bond = await marketContract.getEffectiveBond();
    currentBond = bond;
    $('infoBond').textContent = ethers.formatEther(bond) + ' ETH';

    const liveness = await marketContract.defaultLiveness();
    const liveSec = Number(liveness);
    currentLiveness = liveSec;
    const liveMin = Math.floor(liveSec / 60);
    $('infoLiveness').textContent = liveSec + 's (' + (liveMin >= 60 ? (liveMin / 60) + 'h' : liveMin + 'min') + ')';

    updateTotal();
  } catch (e) {
    $('infoBond').textContent = 'Error';
    $('infoLiveness').textContent = 'Error';
  }

  const mockRow = $('infoMockRow');
  if (cfg.mockOO) {
    mockRow.classList.remove('hidden');
    $('infoMockAddr').textContent = cfg.mockOO;
    $('infoBar').classList.add('has-mock');
  } else {
    mockRow.classList.add('hidden');
    $('infoBar').classList.remove('has-mock');
  }
}

function enableUI() {
  $('createBtn').disabled = false;
  $('lookupBtn').disabled = false;
}

// ─── Total ────────────────────────────────────────────────────────
function updateTotal() {
  const market = $('marketAmt').value;
  const el = $('totalDisplay');
  if (market && !isNaN(Number(market)) && Number(market) >= 0) {
    try {
      const marketWei = ethers.parseEther(market);
      const total = currentBond + marketWei;
      el.textContent = 'Total: ' + ethers.formatEther(total) + ' ETH  =  bond ' + ethers.formatEther(currentBond) + ' + stake ' + market;
      el.style.display = '';
    } catch (_) {
      el.style.display = 'none';
    }
  } else {
    el.style.display = 'none';
  }
}
$('marketAmt').addEventListener('input', updateTotal);

// ─── Create ───────────────────────────────────────────────────────
$('createBtn').addEventListener('click', async () => {
  const claim = $('claimText').value.trim();
  if (!claim) { toast('Enter a claim', 'error', 3000); return; }

  const marketEth = $('marketAmt').value;
  const marketWei = ethers.parseEther(marketEth || '0');
  const total = currentBond + marketWei;

  $('createBtn').disabled = true;
  const t = toast('Sending transaction...', 'pending', 0);

  try {
    const claimBytes = ethers.toUtf8Bytes(claim);
    const tx = await marketContract.createAssertion(claimBytes, { value: total });
    t.textContent = 'TX sent: ' + tx.hash.slice(0, 10) + '...';

    const receipt = await tx.wait();
    t.remove();

    const iface = marketContract.interface;
    let assertionId = null;
    for (const log of receipt.logs) {
      try {
        const parsed = iface.parseLog({ topics: log.topics, data: log.data });
        if (parsed && parsed.name === 'AssertionCreated') {
          assertionId = parsed.args.assertionId;
          break;
        }
      } catch (_) {}
    }

    if (assertionId) {
      toast('Assertion created!', 'success');
      const r = $('createResult');
      r.textContent = 'ID: ' + assertionId;
      r.style.display = '';
      $('lookupId').value = assertionId;
    } else {
      toast('Assertion created (check logs for ID)', 'success');
    }

    loadFeed();
    refreshBalance();
  } catch (e) {
    t.remove();
    toast('Failed: ' + (e.reason || e.message || e), 'error');
  }
  $('createBtn').disabled = false;
});

// ─── Lookup ───────────────────────────────────────────────────────
$('lookupBtn').addEventListener('click', doLookup);
$('lookupId').addEventListener('keydown', e => { if (e.key === 'Enter') doLookup(); });

async function doLookup() {
  const id = $('lookupId').value.trim();
  if (!id) return;
  currentLookupId = id;

  try {
    const d = await marketContract.getAssertionData(id);
    if (d.asserter === ethers.ZeroAddress) {
      toast('Assertion not found', 'error', 3000);
      $('lookupResult').classList.add('hidden');
      return;
    }

    const statusIdx = Number(d.status);
    $('lrStatus').innerHTML = `<span class="tag ${TAG_CLASS[statusIdx]}">${STATUS_MAP[statusIdx]}</span>`;
    $('lrAsserter').textContent = d.asserter;
    $('lrDisputer').textContent = d.disputer === ethers.ZeroAddress ? '(none)' : d.disputer;
    $('lrBond').textContent = ethers.formatEther(d.bondAmount) + ' ETH';
    $('lrMarket').textContent = ethers.formatEther(d.marketAmount) + ' ETH';
    $('lrTime').textContent = new Date(Number(d.timestamp) * 1000).toLocaleString();
    $('lrWithdrawn').textContent = d.withdrawn ? 'Yes' : 'No';

    // Start countdown timer
    startTimer(d.timestamp, statusIdx);

    const actions = $('lrActions');
    actions.innerHTML = '';

    if (statusIdx === 0) {
      const disputeBtn = document.createElement('button');
      disputeBtn.className = 'btn btn-rust btn-sm';
      disputeBtn.textContent = 'Dispute (' + ethers.formatEther(currentBond) + ' ETH)';
      disputeBtn.onclick = () => doDispute(id);
      actions.appendChild(disputeBtn);
    }
    if (statusIdx === 0 || statusIdx === 1) {
      const settleBtn = document.createElement('button');
      settleBtn.className = 'btn btn-teal btn-sm';
      settleBtn.textContent = 'Settle';
      settleBtn.onclick = () => doSettle(id);
      actions.appendChild(settleBtn);
    }
    if ((statusIdx === 2 || statusIdx === 3) && !d.withdrawn) {
      const withdrawBtn = document.createElement('button');
      withdrawBtn.className = 'btn btn-olive btn-sm';
      withdrawBtn.textContent = 'Withdraw';
      withdrawBtn.onclick = () => doWithdraw(id);
      actions.appendChild(withdrawBtn);
    }

    const refreshBtn = document.createElement('button');
    refreshBtn.className = 'btn btn-sm btn-outline';
    refreshBtn.textContent = 'Refresh';
    refreshBtn.onclick = doLookup;
    actions.appendChild(refreshBtn);

    const resolvePanel = $('sandboxResolve');
    if (currentMode === 'sandbox' && statusIdx === 1) {
      resolvePanel.classList.remove('hidden');
    } else {
      resolvePanel.classList.add('hidden');
    }

    $('lookupResult').classList.remove('hidden');
  } catch (e) {
    toast('Lookup failed: ' + (e.reason || e.message), 'error');
  }
}

// ─── Actions ──────────────────────────────────────────────────────
async function doDispute(id) {
  const t = toast('Sending dispute TX...', 'pending', 0);
  try {
    const tx = await marketContract.disputeAssertion(id, { value: currentBond });
    t.textContent = 'TX sent: ' + tx.hash.slice(0, 10) + '...';
    await tx.wait();
    t.remove();
    toast('Disputed successfully!', 'success');
    doLookup();
    refreshBalance();
  } catch (e) { t.remove(); toast('Dispute failed: ' + (e.reason || e.message), 'error'); }
}

async function doSettle(id) {
  const t = toast('Sending settle TX...', 'pending', 0);
  try {
    const tx = await marketContract.settleAssertion(id);
    t.textContent = 'TX sent: ' + tx.hash.slice(0, 10) + '...';
    await tx.wait();
    t.remove();
    toast('Settled successfully!', 'success');
    doLookup();
  } catch (e) { t.remove(); toast('Settle failed: ' + (e.reason || e.message), 'error'); }
}

async function doWithdraw(id) {
  const t = toast('Sending withdraw TX...', 'pending', 0);
  try {
    const tx = await marketContract.withdraw(id);
    t.textContent = 'TX sent: ' + tx.hash.slice(0, 10) + '...';
    await tx.wait();
    t.remove();
    toast('Withdrawn successfully!', 'success');
    doLookup();
    refreshBalance();
  } catch (e) { t.remove(); toast('Withdraw failed: ' + (e.reason || e.message), 'error'); }
}

$('resolveTrue').addEventListener('click', () => doResolve(true));
$('resolveFalse').addEventListener('click', () => doResolve(false));

async function doResolve(truthful) {
  if (!mockOOContract || !currentLookupId) return;
  const label = truthful ? 'TRUE' : 'FALSE';
  const t = toast(`Resolving as ${label}...`, 'pending', 0);
  try {
    const tx = await mockOOContract.resolveAssertion(currentLookupId, truthful);
    t.textContent = 'TX sent: ' + tx.hash.slice(0, 10) + '...';
    await tx.wait();
    t.remove();
    toast(`Resolved as ${label}!`, 'success');
    doLookup();
  } catch (e) { t.remove(); toast('Resolve failed: ' + (e.reason || e.message), 'error'); }
}

// ─── Timer ────────────────────────────────────────────────────────
function startTimer(timestamp, statusIdx) {
  if (timerInterval) { clearInterval(timerInterval); timerInterval = null; }

  const widget = $('timerWidget');
  const track = $('timerTrack');
  const label = $('timerLabel');
  const segments = $('timerSegments');

  // Resolved or withdrawn — show final state
  if (statusIdx === 2 || statusIdx === 3) {
    track.className = 'timer-track expired';
    track.style.width = '100%';
    label.textContent = statusIdx === 2 ? 'RESOLVED TRUE' : 'RESOLVED FALSE';
    segments.innerHTML = `<span class="timer-value expired-text">${statusIdx === 2 ? 'Assertion confirmed' : 'Assertion rejected'}</span>`;
    return;
  }

  // Disputed — awaiting DVM
  if (statusIdx === 1) {
    track.className = 'timer-track disputed';
    track.style.width = '100%';
    label.textContent = 'DISPUTED';
    segments.innerHTML = '<span class="timer-value disputed-text">Awaiting oracle resolution</span>';
    return;
  }

  // Active — countdown
  const expiresAt = Number(timestamp) + currentLiveness;
  label.textContent = 'LIVENESS COUNTDOWN';

  function tick() {
    const now = Math.floor(Date.now() / 1000);
    const remaining = expiresAt - now;
    const elapsed = now - Number(timestamp);
    const pct = Math.min(100, Math.max(0, (elapsed / currentLiveness) * 100));

    if (remaining <= 0) {
      track.className = 'timer-track expired';
      track.style.width = '100%';
      label.textContent = 'LIVENESS EXPIRED';
      segments.innerHTML = '<span class="timer-value expired-text">Ready to settle</span>';
      clearInterval(timerInterval);
      timerInterval = null;
      return;
    }

    const isUrgent = remaining < 300; // < 5 min
    track.className = 'timer-track ' + (isUrgent ? 'urgent' : 'active');
    track.style.width = pct.toFixed(1) + '%';

    const h = Math.floor(remaining / 3600);
    const m = Math.floor((remaining % 3600) / 60);
    const s = remaining % 60;
    const pad = n => String(n).padStart(2, '0');

    segments.innerHTML = `
      <div class="timer-seg"><span class="seg-num${isUrgent ? ' urgent-text' : ''}">${pad(h)}</span><span class="seg-unit">hrs</span></div>
      <span class="timer-colon">:</span>
      <div class="timer-seg"><span class="seg-num${isUrgent ? ' urgent-text' : ''}">${pad(m)}</span><span class="seg-unit">min</span></div>
      <span class="timer-colon">:</span>
      <div class="timer-seg"><span class="seg-num${isUrgent ? ' urgent-text' : ''}">${pad(s)}</span><span class="seg-unit">sec</span></div>
    `;
  }

  tick();
  timerInterval = setInterval(tick, 1000);
}

function formatTimeLeft(timestamp) {
  const expiresAt = Number(timestamp) + currentLiveness;
  const now = Math.floor(Date.now() / 1000);
  const remaining = expiresAt - now;
  if (remaining <= 0) return { text: 'expired', urgent: false };
  const h = Math.floor(remaining / 3600);
  const m = Math.floor((remaining % 3600) / 60);
  if (h > 0) return { text: h + 'h ' + m + 'm', urgent: false };
  if (m > 0) return { text: m + 'm', urgent: remaining < 300 };
  return { text: remaining + 's', urgent: true };
}

// ─── Feed ─────────────────────────────────────────────────────────
let feedLoading = false;
async function loadFeed() {
  if (feedLoading) return; // prevent concurrent loads
  feedLoading = true;
  const feed = $('feed');
  feed.innerHTML = '<div class="feed-empty">Loading...</div>';

  try {
    const filter = marketContract.filters.AssertionCreated();
    const currentBlock = await provider.getBlockNumber();
    const fromBlock = Math.max(0, currentBlock - 50000);
    const events = await marketContract.queryFilter(filter, fromBlock, 'latest');

    if (events.length === 0) {
      feed.innerHTML = '<div class="feed-empty">No assertions yet</div>';
      feedLoading = false;
      return;
    }

    feed.innerHTML = '';
    // Deduplicate by transactionHash+logIndex (bulletproof against RPC dupes)
    const seen = new Set();
    const unique = events.filter(ev => {
      const key = ev.transactionHash + ':' + ev.index;
      if (seen.has(key)) return false;
      seen.add(key);
      return true;
    });
    // Also deduplicate by assertionId in case of reorgs
    const seenIds = new Set();
    const deduped = unique.filter(ev => {
      const id = String(ev.args.assertionId);
      if (seenIds.has(id)) return false;
      seenIds.add(id);
      return true;
    });
    const items = deduped.slice(-20).reverse();

    for (const ev of items) {
      const id = ev.args.assertionId;
      let claimText = '(unable to decode)';
      try { claimText = ethers.toUtf8String(ev.args.claim); } catch(_) {}

      let statusIdx = 0;
      let feedTimestamp = 0;
      try {
        const d = await marketContract.getAssertionData(id);
        statusIdx = Number(d.status);
        feedTimestamp = Number(d.timestamp);
      } catch(_) {}

      let timerHtml = '';
      if (statusIdx === 0 && feedTimestamp > 0 && currentLiveness > 0) {
        const tl = formatTimeLeft(feedTimestamp);
        timerHtml = `<span class="feed-timer${tl.urgent ? ' urgent' : ''}">${tl.text}</span>`;
      }

      const row = document.createElement('div');
      row.className = 'feed-row';
      row.innerHTML = `
        <span class="fid">${id.slice(0, 14)}...</span>
        <span class="fclaim">${escapeHtml(claimText)}</span>
        ${timerHtml}
        <span class="tag ${TAG_CLASS[statusIdx]}">${STATUS_MAP[statusIdx]}</span>
      `;
      row.onclick = () => {
        $('lookupId').value = id;
        doLookup();
        $('lookupId').scrollIntoView({ behavior: 'smooth', block: 'center' });
      };
      feed.appendChild(row);
    }
  } catch (e) {
    feed.innerHTML = '<div class="feed-empty">Error: ' + escapeHtml(e.message) + '</div>';
  }
  feedLoading = false;
}

function escapeHtml(s) {
  const d = document.createElement('div');
  d.textContent = s;
  return d.innerHTML;
}

async function refreshBalance() {
  if (!signer || !provider) return;
  const addr = await signer.getAddress();
  const bal = await provider.getBalance(addr);
  $('walletBal').textContent = parseFloat(ethers.formatEther(bal)).toFixed(4) + ' ETH';
}

if (window.ethereum) {
  window.ethereum.on('accountsChanged', () => window.location.reload());
  window.ethereum.on('chainChanged', () => window.location.reload());
}

$('connectBtn').addEventListener('click', connectWallet);

// ─── Theme Toggle ─────────────────────────────────────────────────
function setTheme(dark) {
  document.documentElement.setAttribute('data-theme', dark ? 'dark' : 'light');
  $('themeBtn').innerHTML = dark ? '&#9788;' : '&#9790;';
  localStorage.setItem('uma-theme', dark ? 'dark' : 'light');
}

$('themeBtn').addEventListener('click', () => {
  const isDark = document.documentElement.getAttribute('data-theme') === 'dark';
  setTheme(!isDark);
});

// Load saved theme
const savedTheme = localStorage.getItem('uma-theme');
if (savedTheme === 'dark') setTheme(true);

if (window.ethereum) {
  window.ethereum.request({ method: 'eth_accounts' }).then(accounts => {
    if (accounts.length > 0) connectWallet();
  });
}
</script>
</body>
</html>
