<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>UMA Assertion Market</title>
<script src="https://cdnjs.cloudflare.com/ajax/libs/ethers/6.13.4/ethers.umd.min.js"></script>
<style>
  :root {
    --bg: #0f1117; --surface: #1a1d27; --border: #2a2d3a;
    --text: #e1e4ed; --muted: #8b8fa3; --accent: #6366f1;
    --blue: #3b82f6; --orange: #f59e0b; --green: #22c55e; --red: #ef4444;
  }
  * { margin: 0; padding: 0; box-sizing: border-box; }
  body { font-family: 'Segoe UI', system-ui, sans-serif; background: var(--bg); color: var(--text); min-height: 100vh; }

  /* Top Bar */
  .topbar { display: flex; justify-content: space-between; align-items: center; padding: 14px 24px; background: var(--surface); border-bottom: 1px solid var(--border); }
  .topbar h1 { font-size: 18px; font-weight: 600; }
  .topbar h1 span { color: var(--accent); }
  .wallet-info { display: flex; align-items: center; gap: 12px; font-size: 13px; color: var(--muted); }
  .wallet-info .addr { color: var(--text); font-family: monospace; }
  .wallet-info .bal { color: var(--green); }

  /* Buttons */
  .btn { padding: 8px 18px; border: none; border-radius: 6px; cursor: pointer; font-size: 13px; font-weight: 600; transition: opacity .15s; }
  .btn:hover { opacity: .85; }
  .btn:disabled { opacity: .4; cursor: not-allowed; }
  .btn-primary { background: var(--accent); color: #fff; }
  .btn-blue { background: var(--blue); color: #fff; }
  .btn-orange { background: var(--orange); color: #000; }
  .btn-green { background: var(--green); color: #000; }
  .btn-red { background: var(--red); color: #fff; }
  .btn-sm { padding: 5px 12px; font-size: 12px; }

  /* Toggle Switch */
  .toggle-wrap { display: flex; align-items: center; gap: 8px; font-size: 13px; }
  .toggle { position: relative; width: 44px; height: 22px; }
  .toggle input { opacity: 0; width: 0; height: 0; }
  .toggle .slider { position: absolute; top: 0; left: 0; right: 0; bottom: 0; background: var(--border); border-radius: 22px; cursor: pointer; transition: .2s; }
  .toggle .slider::before { content: ''; position: absolute; height: 16px; width: 16px; left: 3px; bottom: 3px; background: var(--text); border-radius: 50%; transition: .2s; }
  .toggle input:checked + .slider { background: var(--accent); }
  .toggle input:checked + .slider::before { transform: translateX(22px); }

  /* Layout */
  .container { max-width: 960px; margin: 0 auto; padding: 24px; }
  .grid { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 20px; }
  @media (max-width: 700px) { .grid { grid-template-columns: 1fr; } }

  /* Cards */
  .card { background: var(--surface); border: 1px solid var(--border); border-radius: 10px; padding: 20px; }
  .card h2 { font-size: 15px; font-weight: 600; margin-bottom: 14px; color: var(--muted); text-transform: uppercase; letter-spacing: .5px; }
  .card-full { grid-column: 1 / -1; }

  /* Form */
  label { display: block; font-size: 12px; color: var(--muted); margin-bottom: 4px; margin-top: 10px; }
  input, textarea { width: 100%; padding: 8px 12px; background: var(--bg); border: 1px solid var(--border); border-radius: 6px; color: var(--text); font-size: 13px; font-family: inherit; }
  textarea { resize: vertical; min-height: 60px; }
  input:focus, textarea:focus { outline: none; border-color: var(--accent); }
  .hint { font-size: 11px; color: var(--muted); margin-top: 2px; }

  /* Info row */
  .info-row { display: flex; justify-content: space-between; padding: 6px 0; border-bottom: 1px solid var(--border); font-size: 13px; }
  .info-row:last-child { border-bottom: none; }
  .info-row .label { color: var(--muted); }
  .info-row .value { font-family: monospace; font-weight: 500; }

  /* Status badges */
  .badge { display: inline-block; padding: 2px 8px; border-radius: 4px; font-size: 11px; font-weight: 700; text-transform: uppercase; }
  .badge-active { background: rgba(59,130,246,.15); color: var(--blue); }
  .badge-disputed { background: rgba(245,158,11,.15); color: var(--orange); }
  .badge-true { background: rgba(34,197,94,.15); color: var(--green); }
  .badge-false { background: rgba(239,68,68,.15); color: var(--red); }

  /* Feed */
  .feed-item { display: flex; align-items: center; gap: 10px; padding: 10px; border-bottom: 1px solid var(--border); cursor: pointer; transition: background .1s; font-size: 13px; }
  .feed-item:hover { background: rgba(99,102,241,.05); }
  .feed-item:last-child { border-bottom: none; }
  .feed-id { font-family: monospace; color: var(--accent); font-size: 12px; min-width: 120px; }
  .feed-claim { flex: 1; color: var(--text); white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
  .feed-empty { text-align: center; padding: 24px; color: var(--muted); font-size: 13px; }

  /* Toast */
  .toast-container { position: fixed; bottom: 20px; right: 20px; z-index: 1000; display: flex; flex-direction: column; gap: 8px; }
  .toast { padding: 12px 18px; border-radius: 8px; font-size: 13px; max-width: 360px; animation: slideIn .2s ease; word-break: break-all; }
  .toast-pending { background: #1e293b; border: 1px solid var(--blue); color: var(--blue); }
  .toast-success { background: #052e16; border: 1px solid var(--green); color: var(--green); }
  .toast-error { background: #2a0a0a; border: 1px solid var(--red); color: var(--red); }
  @keyframes slideIn { from { transform: translateX(100%); opacity: 0; } to { transform: translateX(0); opacity: 1; } }

  /* Actions row */
  .actions { display: flex; gap: 8px; margin-top: 14px; flex-wrap: wrap; }

  /* Sandbox resolve section */
  .sandbox-resolve { margin-top: 14px; padding-top: 14px; border-top: 1px solid var(--border); }
  .sandbox-resolve h3 { font-size: 12px; color: var(--orange); margin-bottom: 8px; }

  .hidden { display: none !important; }
</style>
</head>
<body>

<!-- Top Bar -->
<div class="topbar">
  <div style="display:flex;align-items:center;gap:16px;">
    <h1><span>UMA</span> Assertion Market</h1>
    <div class="toggle-wrap">
      <span id="modeLabel" style="font-size:12px;">Live</span>
      <label class="toggle">
        <input type="checkbox" id="modeToggle">
        <span class="slider"></span>
      </label>
      <span style="font-size:12px;color:var(--muted);">Sandbox</span>
    </div>
  </div>
  <div class="wallet-info">
    <span id="networkName"></span>
    <span class="addr" id="walletAddr"></span>
    <span class="bal" id="walletBal"></span>
    <button class="btn btn-primary btn-sm" id="connectBtn">Connect Wallet</button>
  </div>
</div>

<div class="container">

  <!-- Contract Info -->
  <div class="card" style="margin-bottom:20px;">
    <h2>Contract Info</h2>
    <div class="info-row"><span class="label">Market Contract</span><span class="value" id="infoAddr">—</span></div>
    <div class="info-row"><span class="label">Effective Bond</span><span class="value" id="infoBond">—</span></div>
    <div class="info-row"><span class="label">Liveness Period</span><span class="value" id="infoLiveness">—</span></div>
    <div class="info-row hidden" id="infoMockRow"><span class="label">Mock OO (Sandbox)</span><span class="value" id="infoMockAddr">—</span></div>
  </div>

  <div class="grid">

    <!-- Create Assertion -->
    <div class="card">
      <h2>Create Assertion</h2>
      <label>Claim Text</label>
      <textarea id="claimText" placeholder="e.g. ETH was above $2500 on 1 Feb 2026"></textarea>
      <label>Market Amount (ETH)</label>
      <input type="number" id="marketAmt" step="0.001" min="0" value="0.01" placeholder="0.01">
      <div class="hint">Total = bond + market amount. Bond is read from contract.</div>
      <div id="totalDisplay" style="margin-top:8px;font-size:13px;color:var(--accent);"></div>
      <div class="actions">
        <button class="btn btn-primary" id="createBtn" disabled>Create Assertion</button>
      </div>
      <div id="createResult" style="margin-top:10px;font-size:12px;font-family:monospace;color:var(--green);word-break:break-all;"></div>
    </div>

    <!-- Lookup / Manage -->
    <div class="card">
      <h2>Lookup Assertion</h2>
      <label>Assertion ID (bytes32)</label>
      <input type="text" id="lookupId" placeholder="0x...">
      <div class="actions">
        <button class="btn btn-blue btn-sm" id="lookupBtn" disabled>Lookup</button>
      </div>

      <div id="lookupResult" class="hidden" style="margin-top:14px;">
        <div class="info-row"><span class="label">Status</span><span class="value" id="lrStatus">—</span></div>
        <div class="info-row"><span class="label">Asserter</span><span class="value" id="lrAsserter">—</span></div>
        <div class="info-row"><span class="label">Disputer</span><span class="value" id="lrDisputer">—</span></div>
        <div class="info-row"><span class="label">Bond</span><span class="value" id="lrBond">—</span></div>
        <div class="info-row"><span class="label">Market Amount</span><span class="value" id="lrMarket">—</span></div>
        <div class="info-row"><span class="label">Timestamp</span><span class="value" id="lrTime">—</span></div>
        <div class="info-row"><span class="label">Withdrawn</span><span class="value" id="lrWithdrawn">—</span></div>

        <div class="actions" id="lrActions"></div>

        <!-- Sandbox resolve panel -->
        <div id="sandboxResolve" class="sandbox-resolve hidden">
          <h3>Sandbox: Manual Resolution</h3>
          <div class="actions">
            <button class="btn btn-green btn-sm" id="resolveTrue">Resolve TRUE (asserter wins)</button>
            <button class="btn btn-red btn-sm" id="resolveFalse">Resolve FALSE (disputer wins)</button>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Recent Assertions Feed -->
  <div class="card">
    <h2>Recent Assertions</h2>
    <div id="feed"><div class="feed-empty">Connect wallet to view assertions</div></div>
  </div>

</div>

<div class="toast-container" id="toasts"></div>

<script>
// ─── Config ───────────────────────────────────────────────────────────
const CONTRACTS = {
  live: {
    market: '0x8CAb00F1FB2173E35cEE26845aD9D2AaC1502cb4',
    mockOO: null,
    label: 'Live OO v3'
  },
  sandbox: {
    market: '0x44c399D986E8E451cbeF6b52aF152fa846bAA66c',
    mockOO: '0x64d6b8CDe5a488b148A9E6FD53fD3d4a54Cce923',
    label: 'Sandbox'
  }
};

const SEPOLIA_CHAIN_ID = '0xaa36a7'; // 11155111

const MARKET_ABI = [
  'function createAssertion(bytes calldata claim) external payable returns (bytes32)',
  'function disputeAssertion(bytes32 assertionId) external payable',
  'function settleAssertion(bytes32 assertionId) external',
  'function withdraw(bytes32 assertionId) external',
  'function getEffectiveBond() external view returns (uint256)',
  'function getAssertionData(bytes32 assertionId) external view returns (tuple(address asserter, uint64 timestamp, uint8 status, uint128 bondAmount, uint128 marketAmount, address disputer, bool withdrawn))',
  'function defaultLiveness() external view returns (uint64)',
  'function defaultBond() external view returns (uint256)',
  'event AssertionCreated(bytes32 indexed assertionId, address indexed asserter, uint128 bondAmount, uint128 marketAmount, bytes claim)',
  'event AssertionDisputed(bytes32 indexed assertionId, address indexed disputer, uint128 disputeBond)',
  'event AssertionResolved(bytes32 indexed assertionId, bool assertedTruthfully)',
  'event FundsWithdrawn(bytes32 indexed assertionId, address indexed recipient, uint256 amount)'
];

const MOCK_OO_ABI = [
  'function resolveAssertion(bytes32 assertionId, bool truthful) external'
];

const STATUS_MAP = ['Active', 'Disputed', 'ResolvedTrue', 'ResolvedFalse'];
const BADGE_CLASS = ['badge-active', 'badge-disputed', 'badge-true', 'badge-false'];

// ─── State ────────────────────────────────────────────────────────────
let provider = null;
let signer = null;
let marketContract = null;
let mockOOContract = null;
let currentMode = 'live';
let currentBond = 0n;
let currentLookupId = null;

// ─── DOM ──────────────────────────────────────────────────────────────
const $ = id => document.getElementById(id);

// ─── Toast ────────────────────────────────────────────────────────────
function toast(msg, type = 'pending', duration = 5000) {
  const el = document.createElement('div');
  el.className = `toast toast-${type}`;
  el.textContent = msg;
  $('toasts').appendChild(el);
  if (duration > 0) setTimeout(() => el.remove(), duration);
  return el;
}

// ─── Wallet ───────────────────────────────────────────────────────────
async function connectWallet() {
  if (!window.ethereum) { toast('MetaMask not found', 'error'); return; }

  try {
    provider = new ethers.BrowserProvider(window.ethereum);
    const accounts = await provider.send('eth_requestAccounts', []);
    signer = await provider.getSigner();

    // Check network
    const network = await provider.getNetwork();
    if (network.chainId !== 11155111n) {
      toast('Switching to Sepolia...', 'pending', 3000);
      try {
        await window.ethereum.request({ method: 'wallet_switchEthereumChain', params: [{ chainId: SEPOLIA_CHAIN_ID }] });
        provider = new ethers.BrowserProvider(window.ethereum);
        signer = await provider.getSigner();
      } catch (e) {
        toast('Please switch to Sepolia network', 'error');
        return;
      }
    }

    const addr = await signer.getAddress();
    const bal = await provider.getBalance(addr);
    $('walletAddr').textContent = addr.slice(0, 6) + '...' + addr.slice(-4);
    $('walletBal').textContent = parseFloat(ethers.formatEther(bal)).toFixed(4) + ' ETH';
    $('networkName').textContent = 'Sepolia';
    $('connectBtn').textContent = 'Connected';
    $('connectBtn').disabled = true;

    initContracts();
    loadContractInfo();
    loadFeed();
    enableUI();
  } catch (e) {
    toast('Connection failed: ' + e.message, 'error');
  }
}

function initContracts() {
  const cfg = CONTRACTS[currentMode];
  marketContract = new ethers.Contract(cfg.market, MARKET_ABI, signer);
  if (cfg.mockOO) {
    mockOOContract = new ethers.Contract(cfg.mockOO, MOCK_OO_ABI, signer);
  } else {
    mockOOContract = null;
  }
}

async function loadContractInfo() {
  const cfg = CONTRACTS[currentMode];
  $('infoAddr').textContent = cfg.market;

  try {
    const bond = await marketContract.getEffectiveBond();
    currentBond = bond;
    $('infoBond').textContent = ethers.formatEther(bond) + ' ETH';

    const liveness = await marketContract.defaultLiveness();
    const liveSec = Number(liveness);
    const liveMin = Math.floor(liveSec / 60);
    $('infoLiveness').textContent = liveSec + 's (' + (liveMin >= 60 ? (liveMin / 60) + 'h' : liveMin + 'min') + ')';

    updateTotal();
  } catch (e) {
    $('infoBond').textContent = 'Error';
    $('infoLiveness').textContent = 'Error';
  }

  // Mock OO row
  const mockRow = $('infoMockRow');
  if (cfg.mockOO) {
    mockRow.classList.remove('hidden');
    $('infoMockAddr').textContent = cfg.mockOO;
  } else {
    mockRow.classList.add('hidden');
  }
}

function enableUI() {
  $('createBtn').disabled = false;
  $('lookupBtn').disabled = false;
}

// ─── Mode Toggle ──────────────────────────────────────────────────────
$('modeToggle').addEventListener('change', () => {
  currentMode = $('modeToggle').checked ? 'sandbox' : 'live';
  $('modeLabel').textContent = $('modeToggle').checked ? 'Live' : 'Live';
  $('modeLabel').style.color = $('modeToggle').checked ? 'var(--muted)' : 'var(--text)';

  if (signer) {
    initContracts();
    loadContractInfo();
    loadFeed();
    // Clear lookup
    $('lookupResult').classList.add('hidden');
    $('lookupId').value = '';
  }
});

// ─── Total Display ────────────────────────────────────────────────────
function updateTotal() {
  const market = $('marketAmt').value;
  if (currentBond > 0n && market) {
    const marketWei = ethers.parseEther(market || '0');
    const total = currentBond + marketWei;
    $('totalDisplay').textContent = 'Total: ' + ethers.formatEther(total) + ' ETH (bond: ' + ethers.formatEther(currentBond) + ' + market: ' + market + ')';
  }
}
$('marketAmt').addEventListener('input', updateTotal);

// ─── Create Assertion ─────────────────────────────────────────────────
$('createBtn').addEventListener('click', async () => {
  const claim = $('claimText').value.trim();
  if (!claim) { toast('Enter a claim', 'error', 3000); return; }

  const marketEth = $('marketAmt').value;
  const marketWei = ethers.parseEther(marketEth || '0');
  const total = currentBond + marketWei;

  $('createBtn').disabled = true;
  const t = toast('Sending transaction...', 'pending', 0);

  try {
    const claimBytes = ethers.toUtf8Bytes(claim);
    const tx = await marketContract.createAssertion(claimBytes, { value: total });
    t.textContent = 'TX sent: ' + tx.hash.slice(0, 10) + '...';

    const receipt = await tx.wait();
    t.remove();

    // Parse AssertionCreated event
    const iface = marketContract.interface;
    let assertionId = null;
    for (const log of receipt.logs) {
      try {
        const parsed = iface.parseLog({ topics: log.topics, data: log.data });
        if (parsed && parsed.name === 'AssertionCreated') {
          assertionId = parsed.args.assertionId;
          break;
        }
      } catch (_) {}
    }

    if (assertionId) {
      toast('Assertion created: ' + assertionId.slice(0, 14) + '...', 'success');
      $('createResult').textContent = 'ID: ' + assertionId;
      $('lookupId').value = assertionId;
    } else {
      toast('Assertion created (check logs for ID)', 'success');
    }

    loadFeed();
    refreshBalance();
  } catch (e) {
    t.remove();
    toast('Failed: ' + (e.reason || e.message || e), 'error');
  }
  $('createBtn').disabled = false;
});

// ─── Lookup ───────────────────────────────────────────────────────────
$('lookupBtn').addEventListener('click', doLookup);
$('lookupId').addEventListener('keydown', e => { if (e.key === 'Enter') doLookup(); });

async function doLookup() {
  const id = $('lookupId').value.trim();
  if (!id) return;
  currentLookupId = id;

  try {
    const d = await marketContract.getAssertionData(id);
    if (d.asserter === ethers.ZeroAddress) {
      toast('Assertion not found', 'error', 3000);
      $('lookupResult').classList.add('hidden');
      return;
    }

    const statusIdx = Number(d.status);
    $('lrStatus').innerHTML = `<span class="badge ${BADGE_CLASS[statusIdx]}">${STATUS_MAP[statusIdx]}</span>`;
    $('lrAsserter').textContent = d.asserter;
    $('lrDisputer').textContent = d.disputer === ethers.ZeroAddress ? '(none)' : d.disputer;
    $('lrBond').textContent = ethers.formatEther(d.bondAmount) + ' ETH';
    $('lrMarket').textContent = ethers.formatEther(d.marketAmount) + ' ETH';
    $('lrTime').textContent = new Date(Number(d.timestamp) * 1000).toLocaleString();
    $('lrWithdrawn').textContent = d.withdrawn ? 'Yes' : 'No';

    // Build action buttons
    const actions = $('lrActions');
    actions.innerHTML = '';

    if (statusIdx === 0) { // Active
      const disputeBtn = document.createElement('button');
      disputeBtn.className = 'btn btn-orange btn-sm';
      disputeBtn.textContent = 'Dispute (' + ethers.formatEther(currentBond) + ' ETH)';
      disputeBtn.onclick = () => doDispute(id);
      actions.appendChild(disputeBtn);

      const settleBtn = document.createElement('button');
      settleBtn.className = 'btn btn-blue btn-sm';
      settleBtn.textContent = 'Settle';
      settleBtn.onclick = () => doSettle(id);
      actions.appendChild(settleBtn);
    }
    if (statusIdx === 1) { // Disputed
      const settleBtn = document.createElement('button');
      settleBtn.className = 'btn btn-blue btn-sm';
      settleBtn.textContent = 'Settle';
      settleBtn.onclick = () => doSettle(id);
      actions.appendChild(settleBtn);
    }
    if ((statusIdx === 2 || statusIdx === 3) && !d.withdrawn) {
      const withdrawBtn = document.createElement('button');
      withdrawBtn.className = 'btn btn-green btn-sm';
      withdrawBtn.textContent = 'Withdraw';
      withdrawBtn.onclick = () => doWithdraw(id);
      actions.appendChild(withdrawBtn);
    }

    const refreshBtn = document.createElement('button');
    refreshBtn.className = 'btn btn-sm';
    refreshBtn.style.background = 'var(--border)';
    refreshBtn.style.color = 'var(--text)';
    refreshBtn.textContent = 'Refresh';
    refreshBtn.onclick = doLookup;
    actions.appendChild(refreshBtn);

    // Sandbox resolve panel
    const resolvePanel = $('sandboxResolve');
    if (currentMode === 'sandbox' && statusIdx === 1) {
      resolvePanel.classList.remove('hidden');
    } else {
      resolvePanel.classList.add('hidden');
    }

    $('lookupResult').classList.remove('hidden');
  } catch (e) {
    toast('Lookup failed: ' + (e.reason || e.message), 'error');
  }
}

// ─── Actions ──────────────────────────────────────────────────────────
async function doDispute(id) {
  const t = toast('Sending dispute TX...', 'pending', 0);
  try {
    const tx = await marketContract.disputeAssertion(id, { value: currentBond });
    t.textContent = 'TX sent: ' + tx.hash.slice(0, 10) + '...';
    await tx.wait();
    t.remove();
    toast('Disputed successfully!', 'success');
    doLookup();
    refreshBalance();
  } catch (e) {
    t.remove();
    toast('Dispute failed: ' + (e.reason || e.message), 'error');
  }
}

async function doSettle(id) {
  const t = toast('Sending settle TX...', 'pending', 0);
  try {
    const tx = await marketContract.settleAssertion(id);
    t.textContent = 'TX sent: ' + tx.hash.slice(0, 10) + '...';
    await tx.wait();
    t.remove();
    toast('Settled successfully!', 'success');
    doLookup();
  } catch (e) {
    t.remove();
    toast('Settle failed: ' + (e.reason || e.message), 'error');
  }
}

async function doWithdraw(id) {
  const t = toast('Sending withdraw TX...', 'pending', 0);
  try {
    const tx = await marketContract.withdraw(id);
    t.textContent = 'TX sent: ' + tx.hash.slice(0, 10) + '...';
    await tx.wait();
    t.remove();
    toast('Withdrawn successfully!', 'success');
    doLookup();
    refreshBalance();
  } catch (e) {
    t.remove();
    toast('Withdraw failed: ' + (e.reason || e.message), 'error');
  }
}

// Sandbox resolve
$('resolveTrue').addEventListener('click', () => doResolve(true));
$('resolveFalse').addEventListener('click', () => doResolve(false));

async function doResolve(truthful) {
  if (!mockOOContract || !currentLookupId) return;
  const label = truthful ? 'TRUE' : 'FALSE';
  const t = toast(`Resolving as ${label}...`, 'pending', 0);
  try {
    const tx = await mockOOContract.resolveAssertion(currentLookupId, truthful);
    t.textContent = 'TX sent: ' + tx.hash.slice(0, 10) + '...';
    await tx.wait();
    t.remove();
    toast(`Resolved as ${label}!`, 'success');
    doLookup();
  } catch (e) {
    t.remove();
    toast('Resolve failed: ' + (e.reason || e.message), 'error');
  }
}

// ─── Feed ─────────────────────────────────────────────────────────────
async function loadFeed() {
  const feed = $('feed');
  feed.innerHTML = '<div class="feed-empty">Loading...</div>';

  try {
    const filter = marketContract.filters.AssertionCreated();
    const currentBlock = await provider.getBlockNumber();
    // Query last ~50000 blocks (roughly 1 week on Sepolia)
    const fromBlock = Math.max(0, currentBlock - 50000);
    const events = await marketContract.queryFilter(filter, fromBlock, 'latest');

    if (events.length === 0) {
      feed.innerHTML = '<div class="feed-empty">No assertions found</div>';
      return;
    }

    feed.innerHTML = '';
    // Show newest first, max 20
    const items = events.slice(-20).reverse();

    for (const ev of items) {
      const id = ev.args.assertionId;
      let claimText = '(unable to decode)';
      try { claimText = ethers.toUtf8String(ev.args.claim); } catch(_) {}

      // Fetch current status
      let statusIdx = 0;
      try {
        const d = await marketContract.getAssertionData(id);
        statusIdx = Number(d.status);
      } catch(_) {}

      const row = document.createElement('div');
      row.className = 'feed-item';
      row.innerHTML = `
        <span class="feed-id">${id.slice(0, 14)}...</span>
        <span class="feed-claim">${escapeHtml(claimText)}</span>
        <span class="badge ${BADGE_CLASS[statusIdx]}">${STATUS_MAP[statusIdx]}</span>
      `;
      row.onclick = () => {
        $('lookupId').value = id;
        doLookup();
        $('lookupId').scrollIntoView({ behavior: 'smooth', block: 'center' });
      };
      feed.appendChild(row);
    }
  } catch (e) {
    feed.innerHTML = '<div class="feed-empty">Error loading feed: ' + escapeHtml(e.message) + '</div>';
  }
}

// ─── Helpers ──────────────────────────────────────────────────────────
function escapeHtml(s) {
  const d = document.createElement('div');
  d.textContent = s;
  return d.innerHTML;
}

async function refreshBalance() {
  if (!signer || !provider) return;
  const addr = await signer.getAddress();
  const bal = await provider.getBalance(addr);
  $('walletBal').textContent = parseFloat(ethers.formatEther(bal)).toFixed(4) + ' ETH';
}

// ─── Account / Network Change Listeners ───────────────────────────────
if (window.ethereum) {
  window.ethereum.on('accountsChanged', () => window.location.reload());
  window.ethereum.on('chainChanged', () => window.location.reload());
}

// ─── Connect Button ───────────────────────────────────────────────────
$('connectBtn').addEventListener('click', connectWallet);

// Auto-connect if already authorized
if (window.ethereum) {
  window.ethereum.request({ method: 'eth_accounts' }).then(accounts => {
    if (accounts.length > 0) connectWallet();
  });
}
</script>
</body>
</html>
